<div class="dashboard-page">
  <div class="mode-switch">
    <button
      type="button"
      class="mode-switch__btn"
      [class.is-active]="activeMode() === 'lender'"
      (click)="switchMode('lender')"
    >
      Lender Dashboard
    </button>
    <button
      type="button"
      class="mode-switch__btn"
      [class.is-active]="activeMode() === 'borrower'"
      (click)="switchMode('borrower')"
    >
      Borrower Dashboard
    </button>
  </div>

  @if (activeMode() === 'lender') {
    <section class="lender-view">
      <header class="lender-overview">
        <h1>Your Lending/Investment Portfolio</h1>
        <p class="overview-description">
          Track portfolio performance, manage offers, and review returns across your lending activity.
        </p>
        <div class="overview-stats">
          @for (card of lenderSummaryCards(); track card.label) {
            <article class="overview-card" [class.is-accent]="card.accent">
              <div class="overview-card__label">{{ card.label }}</div>
              <div class="overview-card__value">{{ card.value }}</div>
              @if (card.helper) {
                <p class="overview-card__helper">{{ card.helper }}</p>
              }
            </article>
          }
        </div>
        <div class="overview-actions">
          <button type="button" class="action-chip" (click)="openAddFunds()">
            <span class="action-chip__icon">⬆</span>
            <span>Add funds</span>
          </button>
          <button type="button" class="action-chip" (click)="openWithdrawFunds()">
            <span class="action-chip__icon">⬇</span>
            <span>Withdraw</span>
          </button>
          <button type="button" class="action-chip" (click)="goToLend()">
            <span class="action-chip__icon">✎</span>
            <span>Manage offers</span>
          </button>
        </div>
      </header>

      <div class="dashboard-tabs">
        @for (tab of lenderTabs(); track tab.id) {
          <button
            type="button"
            class="dashboard-tabs__btn"
            [class.is-active]="activeLenderTab() === tab.id"
            (click)="setLenderTab(tab.id)"
          >
            {{ tab.label }}
          </button>
        }
      </div>

      @if (isLenderLoading()) {
        <div class="status-banner info">
          Syncing your lending data…
          <button type="button" class="btn btn--ghost btn--small" (click)="refreshLender()">Refresh</button>
        </div>
      } @else if (lenderErrorMessage()) {
        <div class="status-banner error">
          {{ lenderErrorMessage() }}
          <button type="button" class="btn btn--ghost btn--small" (click)="refreshLender()">Try again</button>
        </div>
      }

      <p class="tab-description">{{ currentLenderTab().description }}</p>

      @if (!lenderCurrentCards().length && !isLenderLoading() && !lenderErrorMessage()) {
        <div class="empty-state">
          <h2>No data yet</h2>
          <p>
            Start by publishing an offer or processing existing requests; updates will appear here instantly.
          </p>
          <button type="button" class="btn btn--primary" (click)="goToLend()">Create a lending offer</button>
        </div>
      } @else {
        @if (activeLenderTab() === 'marketplace') {
          <div class="lender-loans">
            @for (loan of lenderMarketplaceCards(); track loan.id) {
              <article class="lender-loan-card lender-loan-card--marketplace">
                <header class="lender-loan-card__header">
                  <div>
                    <h3>{{ loan.title }}</h3>
                    @if (loan.created) {
                      <p>Created {{ loan.created | date:'mediumDate' }}</p>
                    }
                  </div>
                  @if (loan.amount) {
                    <div class="lender-loan-card__amount">{{ loan.amount }}</div>
                  }
                </header>
                <div class="lender-loan-card__meta lender-loan-card__meta--marketplace">
                  @if (loan.rate) {
                    <div>
                      <span class="label">Interest rate</span>
                      <strong>{{ loan.rate }}</strong>
                    </div>
                  }
                  @if (loan.duration) {
                    <div>
                      <span class="label">Duration window</span>
                      <strong>{{ loan.duration }}</strong>
                    </div>
                  }
                  @if (loan.minCreditScore) {
                    <div>
                      <span class="label">Minimum credit score</span>
                      <strong>{{ loan.minCreditScore }}</strong>
                    </div>
                  }
                  @if (loan.minMonthlyIncome) {
                    <div>
                      <span class="label">Minimum monthly income</span>
                      <strong>{{ loan.minMonthlyIncome }}</strong>
                    </div>
                  }
                </div>
                <div class="lender-loan-card__status">
                  @if (loan.badge) {
                    <span class="status-pill" data-tone="info">{{ loan.badge }}</span>
                  } @else if (loan.status) {
                    <span class="status-pill">{{ loan.status }}</span>
                  }
                </div>

                <section class="marketplace-requests">
                  <header class="marketplace-requests__header">
                    <h4>Borrower requests</h4>
                    <span class="marketplace-requests__count">
                      {{ loan.requests.length ? loan.requests.length + ' request(s)' : 'None yet' }}
                    </span>
                  </header>

                  @if (!loan.requests.length) {
                    <div class="marketplace-requests__empty">No borrower requests yet.</div>
                  } @else {
                    @for (request of loan.requests; track request.id) {
                      <article class="borrower-request">
                        <div class="borrower-request__identity">
                          <div class="borrower-request__avatar">{{ request.borrower.slice(0, 1) }}</div>
                          <div>
                            <strong>{{ request.borrower }}</strong>
                            @if (request.submitted) {
                              <p>Requested on: {{ request.submitted | date:'mediumDate' }}</p>
                            }
                          </div>
                        </div>
                        <div class="borrower-request__details">
                          @if (request.creditScore) {
                            <div>
                              <span class="label">Credit score</span>
                              <strong>{{ request.creditScore }}</strong>
                            </div>
                          }
                          @if (request.monthlyIncome) {
                            <div>
                              <span class="label">Monthly income</span>
                              <strong>{{ request.monthlyIncome }}</strong>
                            </div>
                          }
                          @if (request.credibility) {
                            <div>
                              <span class="label">Credibility</span>
                              <strong>{{ request.credibility }}</strong>
                            </div>
                          }
                        </div>
                        <div class="borrower-request__status">
                          @if (request.status) {
                            <span
                              class="status-pill"
                              [attr.data-tone]="request.status === 'Approved' ? 'approved' : request.status === 'Declined' ? 'rejected' : 'pending'"
                            >
                              {{ request.status }}
                            </span>
                          }
                        </div>
                        @if (request.note) {
                          <p class="borrower-request__note">{{ request.note }}</p>
                        }
                      </article>
                    }
                  }
                </section>
              </article>
            }
          </div>
        } @else if (activeLenderTab() === 'active') {
          <div class="lender-loans">
            @for (loan of lenderActiveCards(); track loan.id) {
              <article class="lender-loan-card">
                <header class="lender-loan-card__header">
                  <div>
                    <h3>{{ loan.title }}</h3>
                    @if (loan.borrower) {
                      <p>To {{ loan.borrower }}</p>
                    }
                  </div>
                  @if (loan.principal) {
                    <div class="lender-loan-card__amount">{{ loan.principal }}</div>
                  }
                </header>
                <div class="lender-loan-card__meta">
                  @if (loan.interestRate) {
                    <div>
                      <span class="label">Interest rate</span>
                      <strong>{{ loan.interestRate }}</strong>
                    </div>
                  }
                  @if (loan.term) {
                    <div>
                      <span class="label">Term</span>
                      <strong>{{ loan.term }}</strong>
                    </div>
                  }
                  @if (loan.startDate) {
                    <div>
                      <span class="label">Start date</span>
                      <strong>{{ loan.startDate | date:'mediumDate' }}</strong>
                    </div>
                  }
                  @if (loan.accruedInterest) {
                    <div>
                      <span class="label">Accrued interest</span>
                      <strong>{{ loan.accruedInterest }}</strong>
                    </div>
                  }
                </div>
                <footer class="lender-loan-card__footer">
                  @if (loan.status) {
                    <span class="status-pill">{{ loan.status }}</span>
                  }
                </footer>
              </article>
            }
          </div>
        } @else {
          <div class="lender-loans">
            @for (loan of lenderHistoryCards(); track loan.id) {
              <article class="lender-loan-card">
                <header class="lender-loan-card__header">
                  <div>
                    <h3>{{ loan.title }}</h3>
                    @if (loan.borrower) {
                      <p>To {{ loan.borrower }}</p>
                    }
                  </div>
                  @if (loan.principal) {
                    <div class="lender-loan-card__amount">{{ loan.principal }}</div>
                  }
                </header>
                <div class="lender-loan-card__meta">
                  @if (loan.interestRate) {
                    <div>
                      <span class="label">Interest rate</span>
                      <strong>{{ loan.interestRate }}</strong>
                    </div>
                  }
                  @if (loan.term) {
                    <div>
                      <span class="label">Term</span>
                      <strong>{{ loan.term }}</strong>
                    </div>
                  }
                  @if (loan.startDate) {
                    <div>
                      <span class="label">Start date</span>
                      <strong>{{ loan.startDate | date:'mediumDate' }}</strong>
                    </div>
                  }
                  @if (loan.completed) {
                    <div>
                      <span class="label">Settled</span>
                      <strong>{{ loan.completed | date:'mediumDate' }}</strong>
                    </div>
                  }
                  @if (loan.accruedInterest) {
                    <div>
                      <span class="label">Interest earned</span>
                      <strong>{{ loan.accruedInterest }}</strong>
                    </div>
                  }
                </div>
                <footer class="lender-loan-card__footer">
                  @if (loan.status) {
                    <span class="status-pill">{{ loan.status }}</span>
                  }
                </footer>
              </article>
            }
          </div>
        }
      }
    </section>
  } @else {
    <section class="borrower-view">
      <header class="borrower-overview">
        <h1>Your Loan/Credit Portfolio</h1>
        <p class="overview-description">
          Discover offers tailored to your profile and keep track of new opportunities as they land.
        </p>
        <div class="overview-stats">
          @for (card of borrowerSummaryCards(); track card.label) {
            <article class="overview-card" [class.is-accent]="card.accent">
              <div class="overview-card__label">{{ card.label }}</div>
              <div class="overview-card__value">{{ card.value }}</div>
              @if (card.helper) {
                <p class="overview-card__helper">{{ card.helper }}</p>
              }
            </article>
          }
        </div>
      </header>

      @if (isBorrowerLoading()) {
        <div class="status-banner info">
          Loading tailored offers…
          <button type="button" class="btn btn--ghost btn--small" (click)="refreshBorrower()">Refresh</button>
        </div>
      } @else if (borrowerErrorMessage()) {
        <div class="status-banner error">
          {{ borrowerErrorMessage() }}
          <button type="button" class="btn btn--ghost btn--small" (click)="refreshBorrower()">Try again</button>
        </div>
      }

      <div class="dashboard-tabs borrower-tabs">
        @for (tab of borrowerTabs(); track tab.id) {
          <button
            type="button"
            class="dashboard-tabs__btn"
            [class.is-active]="activeBorrowerTab() === tab.id"
            (click)="setBorrowerTab(tab.id)"
          >
            {{ tab.label }}
          </button>
        }
      </div>

      <p class="tab-description">{{ currentBorrowerTab().description }}</p>

      @if (!borrowerCurrentLoans().length && !isBorrowerLoading() && !borrowerErrorMessage()) {
        <div class="empty-state">
          <h2>{{ currentBorrowerTab().emptyTitle }}</h2>
          <p>{{ currentBorrowerTab().emptyCopy }}</p>
        </div>
      } @else {
        <div class="borrower-loans">
          @for (loan of borrowerCurrentLoans(); track loan.id) {
            <article class="borrower-loan-card">
              <header class="borrower-loan-card__header">
                <div>
                  <h3>{{ loan.name }}</h3>
                  @if (loan.lender) {
                    <p>{{ loan.lender }}</p>
                  }
                </div>
                @if (loan.amountBadge) {
                  <div class="borrower-loan-card__amount">{{ loan.amountBadge }}</div>
                }
              </header>
              <div class="borrower-loan-card__meta">
                @for (meta of loan.meta; track meta.label) {
                  <div>
                    <span class="label">{{ meta.label }}</span>
                    <strong>{{ meta.value }}</strong>
                  </div>
                }
              </div>
              <footer class="borrower-loan-card__footer">
                <div class="borrower-loan-card__footer-main">
                  @if (loan.status) {
                    <span class="status-pill" [attr.data-tone]="loan.tone ?? 'info'">{{ loan.status }}</span>
                  }
                  @if (loan.note) {
                    <p class="loan-note">{{ loan.note }}</p>
                  }
                </div>
              </footer>
            </article>
          }
        </div>
      }
    </section>
  }
</div>
